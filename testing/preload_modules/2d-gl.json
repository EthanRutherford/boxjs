{"entry":"/lib/2d-gl.js","files":{"lib":{"2d-gl.js":{"/code":"module.exports={Renderer:require(\"./core/renderer\"),Scene:require(\"./core/scene\"),ImageLoader:require(\"./core/image-loader\"),rgba:require(\"./core/rgba\"),builtIn:{Shape:require(\"./shape/shape\"),OrthoCamera:require(\"./core/ortho-camera\"),VectorMaterial:require(\"./vector/vector-material\"),SpriteMaterial:require(\"./sprite/sprite-material\")}};"},"sprite":{"sprite-material.js":{"/code":"const Renderable=require(\"../core/renderable\"),SpriteParams=require(\"./sprite-params\"),SpriteShader=require(\"./sprite-shader\");class SpriteMaterial{constructor(e,r){this.texCoords=e,this.imageData=r,this.shaderType=SpriteShader,this.renderableType=Renderable}update(e){this.texCoords=e,this.params&&this.params.update(e)}getParams(e){return this.params||(this.params=new SpriteParams(e,this.texCoords,this.imageData)),this.params}}module.exports=SpriteMaterial;"},"sprite-shader.js":{"/code":"const ShaderProgram=require(\"../core/shader-program\"),spriteVertShader=`\\n\\tattribute vec2 aVPoint;\\n\\tattribute vec2 aTCoord;\\n\\tuniform mat4 uMVMatrix;\\n\\tuniform mat4 uPMatrix;\\n\\tvarying highp vec2 vTextureCoord;\\n\\tvoid main() {\\n\\t\\tgl_Position = uPMatrix * uMVMatrix * vec4(aVPoint, 0, 1);\\n\\t\\tvTextureCoord = aTCoord;\\n\\t}\\n`,spriteFragShader=`\\n\\tvarying highp vec2 vTextureCoord;\\n\\tuniform sampler2D uSampler;\\n\\tvoid main(void) {\\n\\t\\tgl_FragColor = texture2D(uSampler, vTextureCoord.st);\\n\\t}\\n`;class SpriteShader extends ShaderProgram{constructor(t){super(t,spriteVertShader,spriteFragShader),this.gl=t,t.useProgram(t.textureShader),this.aVPoint=t.getAttribLocation(this.program,\"aVPoint\"),t.enableVertexAttribArray(this.aVPoint),this.aTCoord=t.getAttribLocation(this.program,\"aTCoord\"),t.enableVertexAttribArray(this.aTCoord),this.uPMatrix=t.getUniformLocation(this.program,\"uPMatrix\"),this.uMVMatrix=t.getUniformLocation(this.program,\"uMVMatrix\"),this.uSampler=t.getUniformLocation(this.program,\"uSampler\")}setProjection(t){this.gl.uniformMatrix4fv(this.uPMatrix,!1,t)}setModelView(t){this.gl.uniformMatrix4fv(this.uMVMatrix,!1,t)}render(t){const r=this.gl,e=t.params;r.bindBuffer(r.ARRAY_BUFFER,e.vertBuf),r.vertexAttribPointer(this.aVPoint,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,e.texBuf),r.vertexAttribPointer(this.aTCoord,2,r.FLOAT,!1,0,0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e.texture),r.uniform1i(this.uSampler,0),r.drawArrays(e.drawMode,0,e.vertCount)}}module.exports=SpriteShader;"},"sprite-params.js":{"/code":"const{getTexture:getTexture}=require(\"./texture\");class SpriteParams{constructor(t,e,r){this.gl=t,this.texBuf=t.createBuffer(),this.texture=getTexture(t,r),this.drawMode=t.TRIANGLE_FAN,this.update(e)}update(t){const e=t.reduce((t,e)=>(t.push(e.x,e.y),t),[]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW)}}module.exports=SpriteParams;"},"texture.js":{"/code":"function getTexture(e,t){if(!textures.has(t)){const E=e.createTexture();e.bindTexture(e.TEXTURE_2D,E),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST_MIPMAP_LINEAR),e.generateMipmap(e.TEXTURE_2D),textures.set(t,E)}return textures.get(t)}const textures=new Map;module.exports={getTexture:getTexture};"}},"core":{"shader-program.js":{"/code":"function compileShader(r,e,a){const o=r.createShader(a);if(r.shaderSource(o,e),r.compileShader(o),!r.getShaderParameter(o,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(o));return o}function linkShaderProgram(r,e,a){const o=r.createProgram();if(r.attachShader(o,e),r.attachShader(o,a),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS))throw new Error(\"Could not initialize shader\");return o}class ShaderProgram{constructor(r,e,a){const o=compileShader(r,e,r.VERTEX_SHADER),t=compileShader(r,a,r.FRAGMENT_SHADER);this.program=linkShaderProgram(r,o,t)}}module.exports=ShaderProgram;"},"renderable.js":{"/code":"let acc=0;class Renderable{constructor(s,e){this.id=acc++,this.shader=s,this.params=e,this.x=0,this.y=0,this.r=0,this.zIndex=0}}module.exports=Renderable;"},"ortho-camera.js":{"/code":"const{mat4:mat4}=require(\"gl-matrix\");class OrthoCamera{constructor(t=0,i=0,s=1){this._x=t,this._y=i,this._zoom=s,this._dirty=!1,this._aspect=1,this._pMatrix=mat4.create(),this._recreateMatrix()}get x(){return this._x}set x(t){this._x!==t&&(this._x=t,this._dirty=!0)}get y(){return this._y}set y(t){this._y!==t&&(this._y=t,this._dirty=!0)}get zoom(){return this._zoom}set zoom(t){this._zoom!==t&&(this._zoom=t,this._dirty=!0)}set({x:t,y:i,zoom:s}){null!=t&&(this.x=t),null!=i&&(this.y=i),null!=s&&(this.zoom=s)}getBounds(){const{hw:t,hh:i}=this._getHalfDims();return{x0:this._x-t,x1:this._x+t,y0:this._y-i,y1:this._y+i,w:2*t,h:2*i}}getMatrix(t){return t!==this._aspect&&(this._aspect=t,this._dirty=!0),this._recreateMatrix(),this._pMatrix}_getHalfDims(){return{hw:this._zoom*this._aspect/2,hh:this._zoom/2}}_recreateMatrix(){if(!this._dirty)return;this._dirty=!1;const{hw:t,hh:i}=this._getHalfDims(),{x:s,y:h}=this;mat4.ortho(this._pMatrix,s-t,s+t,h-i,h+i,0,-1)}}module.exports=OrthoCamera;"},"rgba.js":{"/code":"module.exports=((e,o,r,a=1)=>({r:e,g:o,b:r,a:a}));"},"image-loader.js":{"/code":"const images={},createImage=window.createImageBitmap?(e,s)=>{s(createImageBitmap(e))}:(e,s)=>{const o=new Image;o.src=URL.createObjectURL(e),o.onload=(()=>s(o))};class ImageLoader{constructor(){this.names=new Set,this.onProgress=null}get(e,s){if(this.names.add(e),!(e in images)){const o={progress:0};images[e]=o,o.promise=new Promise((e,r)=>{const t=new XMLHttpRequest;t.responseType=\"blob\",t.onerror=(()=>r(`${s} not found`)),t.onload=(()=>createImage(t.response,e)),t.onprogress=(e=>{o.progress=e.loaded/e.total,this.onProgress instanceof Function&&this.onProgress(this.getTotalProgress())}),t.open(\"GET\",s,!0),t.send()})}return images[e].promise}all(){const e=[...this.names].map(e=>images[e].promise);return Promise.all(e)}getTotalProgress(){const e=[...this.names];return e.reduce((e,s)=>e+images[s].progress,0)/e.length}}module.exports=ImageLoader;"},"scene.js":{"/code":"class Scene{constructor({renderables:e,getVisibleFunc:s,bgColor:r}){this.getVisibleFunc=s||(()=>[...this.renderables]),this.renderables=new Set(e),this.bgColor=r}add(e){this.renderables.add(e)}has(e){return this.renderables.has(e)}delete(e){this.renderables.delete(e)}getVisible(e){return this.getVisibleFunc(e,this.renderables)}}module.exports=Scene;"},"renderer.js":{"/code":"const{mat4:mat4}=require(\"gl-matrix\"),VectorShader=require(\"../vector/vector-shader\"),SpriteShader=require(\"../sprite/sprite-shader\");class Renderer{constructor(e=null){if(this.canvas=e||document.createElement(\"canvas\"),this.gl=this.canvas.getContext(\"webgl\"),!this.gl)throw new Error(\"could not initialize WebGL\");this.gl.enable(this.gl.BLEND),this.gl.enable(this.gl.DEPTH_TEST),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.aspect=0,this.shaders=new Map,this.createShader(VectorShader),this.createShader(SpriteShader)}createShader(e){this.shaders.has(e)||this.shaders.set(e,new e(this.gl))}getInstance(e,t){const s=this.shaders.get(t.shaderType),r=e.getParams(this.gl),a=t.getParams(this.gl),i=Object.assign({},r,a);return new(0,t.renderableType)(s,i)}resize(){const e=this.canvas.clientWidth,t=this.canvas.clientHeight;t===this.canvas.height&&e===this.canvas.width||(this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,e,t),this.aspect=e/t)}viewportToWorld(e,t,s){const r=e/this.canvas.width,a=1-t/this.canvas.height,{x0:i,y0:h,w:n,h:o}=s.getBounds();return{x:i+r*n,y:h+a*o}}render(e,t){this.resize();const s=t.bgColor;this.gl.clearColor(s.r,s.g,s.b,s.a),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);const r=e.getMatrix(this.aspect),a=mat4.create(),i=t.getVisible(e.getBounds()).reduce((e,t)=>(e.has(t.shader)||e.set(t.shader,[]),e.get(t.shader).push(t),e),new Map);for(const[e,t]of i){this.gl.useProgram(e.program),e.setProjection(r);for(const s of t){const t=s.x,r=s.y,i=1-(16e3*Math.floor(s.zIndex)+s.id%16e3+1)/16e6;mat4.fromTranslation(a,[t,r,i]),mat4.rotateZ(a,a,s.r),e.setModelView(a),e.render(s)}}}}module.exports=Renderer;"}},"vector":{"vector-material.js":{"/code":"function mapDrawMode(e,r){switch(r){case VectorMaterial.triangleFan:return e.TRIANGLE_FAN;case VectorMaterial.lineLoop:return e.LINE_LOOP;case VectorMaterial.lineStrip:return e.LINE_STRIP;case VectorMaterial.points:return e.POINTS;default:return e.TRIANGLE_FAN}}const Renderable=require(\"../core/renderable\"),VectorParams=require(\"./vector-params\"),VectorShader=require(\"./vector-shader\");class VectorMaterial{constructor(e,r=VectorMaterial.triangleFan){this.colors=e,this.drawMode=r,this.shaderType=VectorShader,this.renderableType=Renderable}update(e){this.colors=e,this.params&&this.params.update(e)}getParams(e){if(!this.params){const r=mapDrawMode(e,this.drawMode);this.params=new VectorParams(e,this.colors,r)}return this.params}}VectorMaterial.triangleFan=0,VectorMaterial.lineLoop=1,VectorMaterial.lineStrip=2,VectorMaterial.points=3,module.exports=VectorMaterial;"},"vector-shader.js":{"/code":"const ShaderProgram=require(\"../core/shader-program\"),vectorVertShader=`\\n\\tattribute vec2 aVPoint;\\n\\tattribute vec4 aVColor;\\n\\tuniform mat4 uMVMatrix;\\n\\tuniform mat4 uPMatrix;\\n\\tvarying highp vec4 vColor;\\n\\tvoid main() {\\n\\t\\tgl_Position = uPMatrix * uMVMatrix * vec4(aVPoint, 0, 1);\\n\\t\\tvColor = aVColor;\\n\\t}\\n`,vectorFragShader=`\\n\\tvarying highp vec4 vColor;\\n\\tvoid main() {\\n\\t\\tgl_FragColor = vColor;\\n\\t}\\n`;class VectorShader extends ShaderProgram{constructor(t){super(t,vectorVertShader,vectorFragShader),this.gl=t,this.aVPoint=t.getAttribLocation(this.program,\"aVPoint\"),t.enableVertexAttribArray(this.aVPoint),this.aVColor=t.getAttribLocation(this.program,\"aVColor\"),t.enableVertexAttribArray(this.aVColor),this.uPMatrix=t.getUniformLocation(this.program,\"uPMatrix\"),this.uMVMatrix=t.getUniformLocation(this.program,\"uMVMatrix\")}setProjection(t){this.gl.uniformMatrix4fv(this.uPMatrix,!1,t)}setModelView(t){this.gl.uniformMatrix4fv(this.uMVMatrix,!1,t)}render(t){const r=this.gl,o=t.params;r.bindBuffer(r.ARRAY_BUFFER,o.vertBuf),r.vertexAttribPointer(this.aVPoint,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,o.colorBuf),r.vertexAttribPointer(this.aVColor,4,r.FLOAT,!1,0,0),r.drawArrays(o.drawMode,0,o.vertCount)}}module.exports=VectorShader;"},"vector-params.js":{"/code":"class VectorParams{constructor(t,r,s){this.gl=t,this.colorBuf=t.createBuffer(),this.drawMode=s,this.update(r)}update(t){const r=t.reduce((t,r)=>(t.push(r.r,r.g,r.b,r.a),t),[]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r),this.gl.STATIC_DRAW)}}module.exports=VectorParams;"}},"shape":{"shape.js":{"/code":"const ShapeParams=require(\"./shape-params\");class Shape{constructor(a){this.verts=a}update(a){this.verts=a,this.params&&this.params.update(a)}getParams(a){return this.params||(this.params=new ShapeParams(a,this.verts)),this.params}}module.exports=Shape;"},"shape-params.js":{"/code":"class ShapeParams{constructor(t,e){this.gl=t,this.vertCount=e.length,this.vertBuf=t.createBuffer(),this.update(e)}update(t){const e=t.reduce((t,e)=>(t.push(e.x,e.y),t),[]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW)}}module.exports=ShapeParams;"}}}},"/deps":["gl-matrix"]}